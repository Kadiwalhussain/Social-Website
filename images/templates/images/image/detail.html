{% extends "base.html" %}

{% block title %}{{ image.title }}{% endblock %}

{% block hero %}{% endblock %}

{% block content %}
  <div class="image-detail-layout">
    <div class="image-detail-left">
      <h1>{{ image.title }}</h1>
      <a href="{{ image.image.url }}" target="_blank">
        <img src="{{ image.image.url }}" class="image-detail">
      </a>
      
      {% with total_likes=image.users_like.count users_like=image.users_like.all %}
        <div class="image-info">
          <div class="image-actions">
            <span class="count">
              <span class="total">{{ total_likes }}</span>
              like{{ total_likes|pluralize }}
            </span>
            {% if request.user.is_authenticated %}
            <a href="#" data-id="{{ image.id }}" data-action="{% if request.user in users_like %}un{% endif %}like" class="like button">
              {% if request.user not in users_like %}
                Like
              {% else %}
                Unlike
              {% endif %}
            </a>
            {% endif %}
          </div>
          
          <div class="image-meta">
            <p><strong>Shared by:</strong> 
              <a href="{% url 'account:user_detail' image.user.username %}">
                {{ image.user.get_full_name|default:image.user.username }}
              </a>
            </p>
            <p><strong>Created:</strong> {{ image.created }}</p>
            {% if image.description %}
              <p>{{ image.description|linebreaks }}</p>
            {% endif %}
          </div>
        </div>
        
        <div class="image-likes">
          <h3>Liked by</h3>
          <div class="likes-grid">
            {% for user in users_like %}
              <div class="like-user">
                <a href="{% url 'account:user_detail' user.username %}">
                  {% if user.profile.photo %}
                    <img src="{{ user.profile.photo.url }}" alt="{{ user.username }}">
                  {% endif %}
                  <p>{{ user.first_name|default:user.username }}</p>
                </a>
              </div>
            {% empty %}
              <p class="muted">Nobody has liked this image yet.</p>
            {% endfor %}
          </div>
        </div>
      {% endwith %}
    </div>
    
    <div class="image-detail-right">
      <div class="comments-section">
        <h2>Comments ({{ comments.count }})</h2>
        
        {% if request.user.is_authenticated %}
        <div class="comment-form-wrapper">
          <form method="post" class="comment-form">
            {{ comment_form.as_p }}
            {% csrf_token %}
            <input type="submit" value="Post Comment" class="primary-btn">
          </form>
        </div>
        {% else %}
        <p class="muted">Please <a href="{% url 'account:login' %}">log in</a> to comment.</p>
        {% endif %}
        
        <div class="comments-list">
          {% for comment in comments %}
            <div class="comment">
              <div class="comment-header">
                <a href="{% url 'account:user_detail' comment.user.username %}" class="comment-author">
                  {% if comment.user.profile.photo %}
                    <img src="{{ comment.user.profile.photo.url }}" alt="{{ comment.user.username }}" class="comment-avatar">
                  {% endif %}
                  <strong>{{ comment.user.get_full_name|default:comment.user.username }}</strong>
                </a>
                <span class="comment-date">{{ comment.created|timesince }} ago</span>
              </div>
              <div class="comment-body">
                {{ comment.body|linebreaks }}
              </div>
            </div>
          {% empty %}
            <p class="muted">No comments yet. Be the first to share your thoughts!</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block domready %}
  const url = '{% url "images:like" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }

  document.querySelector('a.like')
    .addEventListener('click', function(e){
      e.preventDefault();
      var likeButton = this;

      // add request body
      var formData = new FormData();
      formData.append('id', likeButton.dataset.id);
      formData.append('action', likeButton.dataset.action);
      options['body'] = formData;

      // send HTTP request
      fetch(url, options)
      .then(response => response.json())
      .then(data => {
        if (data['status'] === 'ok')
        {
          var previousAction = likeButton.dataset.action;

          // toggle button text and data-action
          var action = previousAction === 'like' ? 'unlike' : 'like';
          likeButton.dataset.action = action;
          likeButton.innerHTML = action;

          // update like count
          var likeCount = document.querySelector('span.count .total');
          var totalLikes = parseInt(likeCount.innerHTML);
          likeCount.innerHTML = previousAction === 'like' ? totalLikes + 1 : totalLikes - 1;
        }
      })
    });
{% endblock %}
